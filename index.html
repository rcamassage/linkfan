<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Link Manager (Linky)</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font: Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="loading-indicator" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="p-4 bg-white rounded-xl shadow-2xl flex items-center space-x-3">
            <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm font-medium text-gray-700">데이터 로딩 중...</span>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700">Linky: 심플 링크 관리자</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1">사용자 ID: N/A</p>
        </header>

        <!-- 새 링크 추가 폼 -->
        <div class="bg-white p-6 rounded-2xl shadow-xl mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">새 링크 추가</h2>
            <form id="link-form" class="space-y-4">
                <input type="hidden" id="link-id" value="">

                <div>
                    <label for="link-name" class="block text-sm font-medium text-gray-700 mb-1">링크 이름 (Title)</label>
                    <input type="text" id="link-name" placeholder="예: 구글 검색 엔진" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div>
                    <label for="link-url" class="block text-sm font-medium text-gray-700 mb-1">URL (https://...)</label>
                    <input type="url" id="link-url" placeholder="예: https://www.google.com" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <div class="flex space-x-3">
                    <button type="submit" id="submit-button"
                            class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        링크 저장
                    </button>
                    <button type="button" id="cancel-button"
                            class="w-1/4 py-3 px-4 bg-gray-300 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-200 hidden">
                        취소
                    </button>
                </div>
            </form>
        </div>

        <!-- 링크 목록 -->
        <div class="bg-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">저장된 링크 목록</h2>
            <div id="link-list" class="space-y-4">
                <p class="text-gray-500 text-center" id="empty-state">로딩 중... 또는 여기에 링크가 표시됩니다.</p>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Confirmation -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3">확인</h3>
            <p id="modal-message" class="text-gray-600 mb-6">정말로 이 작업을 수행하시겠습니까?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">취소</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">확인</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK 로드 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore 로깅 레벨 설정 (디버깅용)
        setLogLevel('Debug');

        // 전역 변수 설정 (캔버스 환경에서 제공됨)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading';
        let linksCollectionRef;
        let isAuthReady = false;

        const linkForm = document.getElementById('link-form');
        const linkList = document.getElementById('link-list');
        const linkIdInput = document.getElementById('link-id');
        const linkNameInput = document.getElementById('link-name');
        const linkUrlInput = document.getElementById('link-url');
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-button');
        const emptyState = document.getElementById('empty-state');
        const loadingIndicator = document.getElementById('loading-indicator');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // Modal elements
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let modalAction = null; // Stores the function to execute on confirmation

        /**
         * 커스텀 모달 표시
         * @param {string} title - 모달 제목
         * @param {string} message - 모달 메시지
         * @param {function} onConfirm - '확인' 버튼 클릭 시 실행할 함수
         */
        function showModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalAction = onConfirm;
            customModal.classList.remove('hidden');
            customModal.classList.add('flex');
            modalConfirmBtn.focus();
        }

        function hideModal() {
            customModal.classList.remove('flex');
            customModal.classList.add('hidden');
            modalAction = null;
        }

        modalConfirmBtn.onclick = () => {
            if (modalAction) {
                modalAction();
            }
            hideModal();
        };

        modalCancelBtn.onclick = hideModal;

        // Firebase 초기화 및 인증 설정
        async function initializeFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Configuration is missing.");
                    emptyState.textContent = "Firebase 설정 오류: 앱을 로드할 수 없습니다.";
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                loadingIndicator.classList.remove('hidden');
                
                // 인증 상태 변경 리스너 설정
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // 사용자 ID가 없으면 익명 로그인 시도
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }

                    userIdDisplay.textContent = `사용자 ID: ${userId.substring(0, 8)}...`;
                    // 컬렉션 경로 설정: /artifacts/{appId}/users/{userId}/links
                    linksCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'links');
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    fetchLinksRealtime();
                    loadingIndicator.classList.add('hidden');
                });

                // 커스텀 토큰으로 로그인 시도
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // 토큰이 없으면 onAuthStateChanged에서 익명 로그인 처리
                    console.log("No custom token provided, waiting for onAuthStateChanged to handle login.");
                }

            } catch (error) {
                console.error("Firebase 초기화 또는 인증 중 오류 발생:", error);
                emptyState.textContent = "Firebase 오류: 데이터 로딩에 실패했습니다.";
                loadingIndicator.classList.add('hidden');
            }
        }

        // 링크 목록 실시간 감지 및 렌더링
        function fetchLinksRealtime() {
            if (!isAuthReady) {
                console.warn("Auth not ready, cannot fetch links.");
                return;
            }

            // Firestore 쿼리 (정렬을 위해 클라이언트 측에서 정렬)
            const q = query(linksCollectionRef);

            // 실시간 리스너 설정
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (!isAuthReady) return; // 다시 확인

                const links = [];
                snapshot.forEach(doc => {
                    // 데이터 검증 및 역직렬화 (필요시)
                    links.push({ id: doc.id, ...doc.data() });
                });

                // 생성 시간 (timestamp)을 기준으로 내림차순 정렬 (최신 링크가 위로 오도록)
                links.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
                
                renderLinks(links);
            }, (error) => {
                console.error("링크 실시간 업데이트 감지 중 오류 발생:", error);
                emptyState.textContent = "링크 로딩 중 오류가 발생했습니다.";
            });

            // 클린업 함수를 반환할 수 있지만, 단일 페이지 앱이므로 생략
            // return unsubscribe;
        }

        // 링크 목록 UI 렌더링
        function renderLinks(links) {
            linkList.innerHTML = '';
            if (links.length === 0) {
                emptyState.textContent = "아직 저장된 링크가 없습니다. 새 링크를 추가해 보세요!";
                linkList.appendChild(emptyState);
                return;
            }
            
            // emptyState가 있으면 숨김
            if (emptyState.parentNode === linkList) {
                linkList.removeChild(emptyState);
            }

            links.forEach(link => {
                // Link Card UI
                const linkCard = document.createElement('div');
                linkCard.className = 'link-card p-4 border border-gray-200 bg-gray-50 rounded-xl shadow-sm hover:shadow-md transition duration-200 flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0';
                linkCard.dataset.id = link.id;

                // Content Area
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-grow w-full md:w-auto overflow-hidden';

                // Title (Name)
                const titleElement = document.createElement('a');
                titleElement.href = link.url;
                titleElement.target = '_blank';
                titleElement.rel = 'noopener noreferrer';
                titleElement.textContent = link.name;
                titleElement.className = 'text-lg font-semibold text-indigo-700 hover:text-indigo-900 truncate block';

                // URL
                const urlElement = document.createElement('p');
                urlElement.textContent = link.url;
                urlElement.className = 'text-sm text-gray-500 truncate block';

                contentDiv.appendChild(titleElement);
                contentDiv.appendChild(urlElement);

                // Actions Area
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex space-x-2 flex-shrink-0';
                
                // Edit Button
                const editButton = document.createElement('button');
                editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-4.42 2.828L15.414 10l-2.828 2.828-5.657-5.657 2.828-2.828zM3 17.25V14.5l8.5-8.5 2.75 2.75-8.5 8.5H3z"/></svg>`;
                editButton.className = 'p-2 rounded-full text-indigo-500 hover:bg-indigo-100 transition';
                editButton.title = '편집';
                editButton.onclick = () => startEditLink(link);

                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"/></svg>`;
                deleteButton.className = 'p-2 rounded-full text-red-500 hover:bg-red-100 transition';
                deleteButton.title = '삭제';
                deleteButton.onclick = () => showModal(
                    '링크 삭제 확인', 
                    `정말로 '${link.name}' 링크를 삭제하시겠습니까?`, 
                    () => deleteLink(link.id)
                );

                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);

                linkCard.appendChild(contentDiv);
                linkCard.appendChild(actionsDiv);

                linkList.appendChild(linkCard);
            });
        }

        // 링크 추가 및 업데이트 처리
        linkForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!isAuthReady) {
                console.error("Firebase Auth가 준비되지 않았습니다. 잠시 후 다시 시도해 주세요.");
                return;
            }

            loadingIndicator.classList.remove('hidden');

            const id = linkIdInput.value.trim();
            const name = linkNameInput.value.trim();
            const url = linkUrlInput.value.trim();
            
            // 간단한 URL 유효성 검사 (browser type="url" handles most, but enforce https)
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                // 커스텀 모달을 사용하여 경고 표시
                showModal('URL 형식 오류', 'URL은 "http://" 또는 "https://"로 시작해야 합니다.', () => {});
                loadingIndicator.classList.add('hidden');
                return;
            }

            const linkData = {
                name: name,
                url: url,
            };

            try {
                if (id) {
                    // 업데이트
                    const docRef = doc(db, linksCollectionRef.path, id);
                    await updateDoc(docRef, linkData);
                    console.log("Link updated:", id);
                } else {
                    // 추가
                    await addDoc(linksCollectionRef, {
                        ...linkData,
                        timestamp: Date.now() // 타임스탬프 추가
                    });
                    console.log("Link added.");
                }

                // 폼 초기화 및 편집 모드 종료
                resetForm();

            } catch (error) {
                console.error("링크 저장/업데이트 중 오류 발생:", error);
                showModal('오류', '링크 저장/업데이트 중 문제가 발생했습니다.', () => {});
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

        // 편집 모드 시작
        function startEditLink(link) {
            linkIdInput.value = link.id;
            linkNameInput.value = link.name;
            linkUrlInput.value = link.url;
            submitButton.textContent = '링크 수정 완료';
            submitButton.classList.replace('bg-indigo-600', 'bg-green-600');
            submitButton.classList.replace('hover:bg-indigo-700', 'hover:bg-green-700');
            cancelButton.classList.remove('hidden');
            linkNameInput.focus();
        }

        // 폼 초기화 및 편집 모드 종료
        function resetForm() {
            linkForm.reset();
            linkIdInput.value = '';
            submitButton.textContent = '링크 저장';
            submitButton.classList.replace('bg-green-600', 'bg-indigo-600');
            submitButton.classList.replace('hover:bg-green-700', 'hover:bg-indigo-700');
            cancelButton.classList.add('hidden');
        }

        // 취소 버튼 이벤트
        cancelButton.onclick = resetForm;

        // 링크 삭제
        async function deleteLink(id) {
            if (!isAuthReady) return;
            loadingIndicator.classList.remove('hidden');
            try {
                const docRef = doc(db, linksCollectionRef.path, id);
                await deleteDoc(docRef);
                console.log("Link deleted:", id);
            } catch (error) {
                console.error("링크 삭제 중 오류 발생:", error);
                showModal('오류', '링크 삭제 중 문제가 발생했습니다.', () => {});
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // 앱 시작
        initializeFirebase();

    </script>
</body>
</html>
